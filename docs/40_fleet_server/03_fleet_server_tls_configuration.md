
# **03 — Configuring Fleet Server TLS (Advanced On‑Premises, Production Mode)**

This note documents the **Advanced** + **Production mode** workflow from the Elastic on‑premises guide.  
Fleet Server runs on the **same VM** as Elasticsearch and Kibana and uses **your own PKI certificates**.

All configuration is performed in the **Kibana UI**, and Fleet Server is installed using the **production‑grade command generated by Kibana**.

---

## **1. Open the Fleet Server Setup (Advanced + Production Mode)**

In Kibana:

1. Go to **Management → Fleet → Agents**  
2. Click **Add Fleet Server**  
3. Select **On‑premises**  
4. Choose **Advanced**  
5. Select **Production mode**

Production mode ensures:

- persistent installation  
- systemd service creation  
- secure defaults  
- non‑interactive enrollment  

This is the correct choice for your PKI‑secured lab.

---

## **2. Select or Create a Fleet Server Policy**

Kibana will prompt you to choose a **Fleet Server policy**.

You may:

- Select an existing Fleet Server policy, or  
- Create a new one

A Fleet Server policy:

- Configures Elastic Agent to run in Fleet Server mode  
- Defines the Fleet Server integration  
- Specifies the Fleet Server port (default: **8220**)  

---

## **3. Configure the Fleet Server Host**

Enter the Fleet Server host URL that matches the SAN in your certificate:

```
https://fleet.soc.cti:8220
```

Notes:

- Must match a SAN in `fleet-server.crt`  
- This is the URL Elastic Agents will use to connect  

---

## **4. Configure the Elasticsearch URL**

Enter the Elasticsearch HTTPS endpoint:

```
https://es.soc.cti:9200
```

Notes:

- Must match a SAN in the Elasticsearch certificate  
- Fleet Server uses this to authenticate and register itself  

---

## **5. Provide the Fleet Server Service Token**

Kibana will display or allow you to generate a **service token**.

Paste it into the Service Token field.

Example format:

```
AAEAAWVsYXN0aWMvZmxlZXQtc2VydmVyL3Rva2VuLTEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5
```

Notes:

- This token authorizes Fleet Server to enroll with Elasticsearch  
- A unique token per Fleet Server is recommended  

---

## **6. Enable TLS and Provide Certificate Paths**

In the TLS section, choose:

**Use your own certificates**

Then provide the paths from Note 02:

### **Fleet Server certificate**
```
/etc/fleet-server/certs/fleet-server.crt
```

### **Fleet Server private key**
```
/etc/fleet-server/certs/fleet-server.key
```

### **CA certificate chain**
```
/etc/fleet-server/certs/ca-chain.crt
```

Permissions must be:

```
chmod 750 /etc/fleet-server/certs/
chmod 600 /etc/fleet-server/certs/fleet-server.key
chmod 644 /etc/fleet-server/certs/*.crt
```

---

## **7. Review the Production‑Mode Install Command**

After completing all fields, Kibana generates the **production‑grade** Fleet Server installation command.

It will look similar to:

```
sudo elastic-agent install \
  --url=https://fleet.soc.cti:8220 \
  --fleet-server-es=https://es.soc.cti:9200 \
  --fleet-server-service-token=<TOKEN> \
  --fleet-server-policy=<POLICY_ID> \
  --fleet-server-cert=/etc/fleet-server/certs/fleet-server.crt \
  --fleet-server-cert-key=/etc/fleet-server/certs/fleet-server.key \
  --fleet-server-es-ca=/etc/fleet-server/certs/ca-chain.crt
```

Notes:

- **Do not modify the command**  
- Kibana ensures all flags match your configuration  
- The command installs Elastic Agent *and* enrolls Fleet Server  

---

## **8. Run the Install Command on the VM**

Copy the command from Kibana and run it in the terminal

Expected behavior:

- Elastic Agent downloads and installs  
- Fleet Server enrolls with Elasticsearch  
- A systemd service is created and started  
- Fleet Server appears in Kibana under **Fleet → Fleet Servers**  

If needed, follow logs:

```
sudo journalctl -u elastic-agent -f
```

---

## **9. Confirm Fleet Server Is Healthy**

In Kibana:

**Management → Fleet → Fleet Servers**

Expected:

- Status: **Healthy**  
- Host: `fleet.soc.cti`  
- Port: `8220`  
- TLS: **Enabled**  
- Last check‑in: recent  

If the status is **Unhealthy**, see Note 04.

---

## **10. Learning Notes**

- The **Advanced + Production mode** workflow is required for on‑premises deployments with custom PKI  
- Kibana generates the correct install command — no manual construction  
- SAN validation is strict: hostnames must match exactly  
- The CA chain must include both Root and Intermediate CA  
- The Fleet Server policy defines how the agent runs in Fleet Server mode  

---

# **11. References**

**Add a Fleet Server on‑premises (Advanced + Production mode)**  
`https://www.elastic.co/docs/reference/fleet/add-fleet-server-on-prem`  
(Search: elastic.co add fleet server on prem)

**Configure SSL/TLS for self‑managed Fleet Servers**  
`https://www.elastic.co/docs/reference/fleet/add-fleet-server-on-prem#fleet-server-tls`  
(Search: elastic.co fleet server tls)

**Elastic Agent install command reference**  
`https://www.elastic.co/docs/reference/elastic-agent/elastic-agent-install-command`  
(Search: elastic.co elastic agent install command)

**Fleet Server requirements**  
`https://www.elastic.co/docs/reference/fleet/fleet-server-requirements`  
(Search: elastic.co fleet server requirements)

